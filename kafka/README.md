
## Концепция

* `sasl` - Механизм аутентификации 
  * `PLAIN` - Пароли в конфиге.
  * [SCRAM-SHA-256\SCRAM-SHA-512](../Шифрование/SCRAM.md )
  * `GSSAPI` - (Kerberos)
  * `OAUTHBEARER` - JWT-токены с внешним провайдером.
* Методы хранения метаданных топиков:
  * `ZooKeeper` - отдельный сервер (на нём нужно отдельно настраивать sasl)
  * `KRaft` - на брокерах (более современный).
* ACL - Права на ресурсы для пользователей, прошедших первичную аутентификацию.
  * Для корректной работы acl с современными методами авторизации нужно добавить в конфиг сервера:
    * authorizer.class.name=org.apache.kafka.metadata.authorizer.StandardAuthorizer - метод авторизации
    * super.users: User:admin;User:controller_user;User:inter_broker_user - Пользователи, игнорирующие acl.
* JKS - Формат хранения сертификатов для java
* Особенности кластера kafka
  * Следующие параметры должны соответствовать количеству реплик кластера, иначе сообщения не дойдут:
    * offsets.topic.replication.factor: <Количество реплик>
    * transaction.state.log.replication.factor: <Количество реплик>

## Установка

#### clusterDomain
* Домен требуется заполнять актуальным значением!
  {{- $nodeAddress := printf "%s-%d.%s.%s.svc.%s:%d" $fullname (int $i) $serviceName $releaseNamespace $clusterDomain $port -}}
  controller.quorum.bootstrap.servers: $nodeAddress

#### listeners
* Настройка SASL_SSL без аутентификации по tls 
```yaml
listeners:
  client:
    containerPort: 9092
    protocol: SASL_SSL
    name: CLIENT
    sslClientAuth: "none"
  controller:
    name: CONTROLLER
    containerPort: 9093
    protocol: SASL_SSL
    sslClientAuth: "none"
  interbroker:
    containerPort: 9094
    protocol: SASL_SSL
    name: INTERNAL
    sslClientAuth: "none"
  external:
    containerPort: 9095
    protocol: SASL_SSL
    name: EXTERNAL
    sslClientAuth: "none"
```
#### sasl
* Вариант с паролями в конфиге из секрета.
```yaml
  enabledMechanisms: PLAIN
  interBrokerMechanism: PLAIN
  controllerMechanism: PLAIN
  interbroker:
    user: inter_broker_user
    password: ""
    clientId: inter_broker_client
    clientSecret: ""
  controller:
    user: controller_user
    password: ""
    clientId: controller_broker_client
    clientSecret: ""
  client:
    users:
      - admin
      - telebot-gpt
    passwords: ""
  existingSecret: "kafka-secrets"
```
#### sasl
* Сертификаты в формате JKS, с паролями, без аутентификации клиентов через сертификаты
```yaml
tls:
  type: JKS
  pemChainIncluded: false
  autoGenerated:
    enabled: false
  existingSecret: "cm-kafka-jks"
  passwordsSecret: "kafka-secrets"
  passwordsSecretKeystoreKey: jks-cert-password
  passwordsSecretTruststoreKey: jks-cert-password
  passwordsSecretPemPasswordKey: ""
  jksKeystoreKey: "keystore.jks"
  jksTruststoreSecret: ""
  jksTruststoreKey: "truststore.jks"
  endpointIdentificationAlgorithm: https
  sslClientAuth: "none"
```
#### controller
* Кластер из одной реплики, где `process.roles=controller,broker`. Без хранилища!
```yaml
controller:
  replicaCount: 1
  overrideConfiguration:
    offsets.topic.replication.factor: 1
    transaction.state.log.replication.factor: 1
    authorizer.class.name: org.apache.kafka.metadata.authorizer.StandardAuthorizer
    super.users: User:admin;User:controller_user;User:inter_broker_user
  resourcesPreset: "medium"
  persistence:
    enabled: false
  logPersistence:
    enabled: false
```
#### provisioning
* waitForKafka: true - не работает с сертификатами (не монтирует их), реализовано руками.
* для проверки сервера: kafka-broker-api-versions.sh может не срабатывать, можно заменить на kafka-topics.sh --list 
```yaml
provisioning:
  enabled: true
  waitForKafka: false
  useHelmHooks: true
  automountServiceAccountToken: false
  topics: # Топики менять по необходимости
    - name: telebot-gpt-test
      partitions: 1
      replicationFactor: 1
  extraProvisioningCommands:
#    # ===== ПРАВА ДЛЯ ПОЛЬЗОВАТЕЛЯ (telebot-gpt) =====
#    # Полные права на топики telebot-gpt-*
    - /opt/bitnami/kafka/bin/kafka-acls.sh \
        --bootstrap-server $KAFKA_SERVICE \
        --command-config /shared/client.properties \
        --add \
        --allow-principal User:telebot-gpt \
        --consumer \
        --producer \
        --group '*' \
        --topic telebot-gpt- \
        --resource-pattern-type prefixed
#  preScript: |
#    while true; do
#      if /opt/bitnami/kafka/bin/kafka-broker-api-versions.sh --bootstrap-server ${KAFKA_SERVICE} --command-config /shared/client.properties >/dev/null 2>&1; then
#        echo "Kafka is ready!"
#        break
#      fi
#      echo "Waiting for Kafka to be ready..."
#      sleep 5
#    done
  preScript: |
    while true; do
      if /opt/bitnami/kafka/bin/kafka-topics.sh --list --bootstrap-server ${KAFKA_SERVICE} --command-config /shared/client.properties >/dev/null 2>&1; then
        echo "Kafka is ready!"
        break
      fi
      echo "Waiting for Kafka to be ready..."
      sleep 5
    done

  auth:
    ## TLS configuration for kafka provisioning Job
    ##
    tls:
      ## @param provisioning.auth.tls.type Format to use for TLS certificates. Allowed types: `JKS` and `PEM`.
      ## Note: ignored if auth.tls.client.protocol different from one of these values: "SSL" "SASL_SSL"
      ##
      type: JKS
      certificatesSecret: "cm-kafka-jks"
      keystore: keystore.jks
      truststore: truststore.jks
      passwordsSecret: "kafka-secrets"
      keyPasswordSecretKey: "jks-cert-password"
      keystorePasswordSecretKey: "jks-cert-password"
      truststorePasswordSecretKey: "jks-cert-password"
  serviceAccount:
    create: true
    name: "kafka-provisioning-sa"
    automountServiceAccountToken: false
  resourcesPreset: "medium"
  resources: {}
  podSecurityContext:
    enabled: true
    fsGroupChangePolicy: Always
    sysctls: []
    supplementalGroups: []
    fsGroup: 1001
#    seccompProfile:
#      type: "RuntimeDefault"
  containerSecurityContext:
    enabled: true
    seLinuxOptions: {}
    runAsUser: 1001
    runAsGroup: 1001
    runAsNonRoot: true
    allowPrivilegeEscalation: false
    readOnlyRootFilesystem: true
#    capabilities:
#      drop: ["ALL"]

```

## Тестирование
#### Клиент
```yaml
apiVersion: v1
kind: Pod
metadata:
  name: kafka-client
  namespace: storage
spec:
  containers:
    - name: kafka-client
      image: docker.io/bitnami/kafka:4.0.0-debian-12-r8
      command: ["sleep", "infinity"]
      volumeMounts:
        - name: kafka-cert
          mountPath: /tmp/cert
          readOnly: true
  volumes:
    - name: kafka-cert
      secret:
        secretName: cm-kafka-jks
```
```shell
nano /tmp/kafka-client-pod.yaml
kubectl apply -f /tmp/kafka-client-pod.yaml
kubectl delete -f /tmp/kafka-client-pod.yaml
```
#### Тестирование
```shell
# Логи controller
kubectl logs -f -n storage --selector=app.kubernetes.io/component=controller-eligible
# Логи provisioning
kubectl logs -f -n storage --selector=app.kubernetes.io/component=kafka-provisioning


cat > /tmp/client.properties.admin <<EOF
security.protocol=SASL_SSL
ssl.keystore.type=JKS
ssl.truststore.type=JKS
ssl.key.password=u2tb6alf
ssl.keystore.location=/tmp/cert/keystore.jks
ssl.truststore.location=/tmp/cert/truststore.jks
ssl.keystore.password=u2tb6alf
ssl.truststore.password=u2tb6alf
sasl.mechanism=PLAIN
sasl.jaas.config=org.apache.kafka.common.security.plain.PlainLoginModule required username="admin" password="!!!!!!!!!!";
EOF

cat > /tmp/client.properties.telebot <<EOF
security.protocol=SASL_SSL
ssl.keystore.type=JKS
ssl.truststore.type=JKS
ssl.key.password=u2tb6alf
ssl.keystore.location=/tmp/cert/keystore.jks
ssl.truststore.location=/tmp/cert/truststore.jks
ssl.keystore.password=u2tb6alf
ssl.truststore.password=u2tb6alf
sasl.mechanism=PLAIN
sasl.jaas.config=org.apache.kafka.common.security.plain.PlainLoginModule required username="telebot-gpt" password="!!!!!!!!!";
EOF

# Доступность user:admin
kafka-broker-api-versions.sh --bootstrap-server kafka:9092 --command-config /tmp/client.properties.admin
# Список топиков user:admin
kafka-topics.sh --list --bootstrap-server kafka:9092 --command-config /tmp/client.properties.admin
# Права пользователей (не super.users) user:admin
kafka-acls.sh --bootstrap-server kafka:9092 --list --command-config /tmp/client.properties.admin
# Список топиков user:telebot
kafka-topics.sh --list --bootstrap-server kafka:9092 --command-config /tmp/client.properties.telebot
# Отправка сообщений user:telebot
kafka-console-producer.sh --topic telebot-gpt-test --bootstrap-server kafka:9092 --producer.config /tmp/client.properties.telebot
# Получение сообщений user:telebot
kafka-console-consumer.sh --bootstrap-server kafka:9092 --topic telebot-gpt-test --from-beginning --group test-group --consumer.config /tmp/client.properties.telebot 
```


#### clusterDomain


#### provisioning (Первоначальная настройка)
* initContainer ожидающий Kafka работает только без сертификатов.
provisioning.waitForKafka: false
* Добавить скрипт ожидания в provisioning
```yaml
provisioning:
  preScript: |
    #!/bin/bash

    . /opt/bitnami/scripts/libos.sh
  
    while true; do
      if /opt/bitnami/kafka/bin/kafka-broker-api-versions.sh --bootstrap-server "${KAFKA_SERVICE}" --command-config /shared/client.properties >/dev/null 2>&1; then
        echo "Kafka is ready!"
        break
      fi
      echo "Waiting for Kafka to be ready..."
      sleep 5
    done
```

kafka-topics.sh --list --bootstrap-server kafka:9092 --command-config /tmp/client.properties


/opt/bitnami/kafka/bin/kafka-acls.sh \
  --bootstrap-server $KAFKA_SERVICE \
  --command-config /tmp/client.properties.admin \
  --add \
  --allow-principal User:telebot-gpt \
  --producer \
  --topic telebot-gpt- \
  --resource-pattern-type prefixed


/opt/bitnami/kafka/bin/kafka-acls.sh \
  --bootstrap-server kafka:9092 \
  --command-config /tmp/client.properties.admin \
  --add \
  --allow-principal User:telebot-gpt \
  --consumer \
  --producer \
  --group '*' \
  --topic test- \
  --resource-pattern-type prefixed


kafka-acls.sh --bootstrap-server $KAFKA_SERVICE --add --allow-principal User:telebot-gpt --operation Write --topic '*' --command-config /shared/client.properties



## Проверка настроек


cat > /tmp/client.properties <<EOF
security.protocol=SASL_SSL
ssl.truststore.location=/tmp/cert/truststore.jks
ssl.truststore.password=u2tb6alf
ssl.keystore.location=/tmp/cert/keystore.jks
ssl.keystore.password=u2tb6alf
ssl.key.password=u2tb6alf
sasl.mechanism=PLAIN
sasl.jaas.config=org.apache.kafka.common.security.plain.PlainLoginModule required username="admin" password="dc95frub";
EOF

cat > /tmp/client.properties <<EOF
security.protocol=SASL_SSL
ssl.keystore.type=JKS
ssl.truststore.type=JKS
ssl.key.password=u2tb6alf
ssl.keystore.location=/tmp/cert/keystore.jks
ssl.truststore.location=/tmp/cert/truststore.jks
ssl.keystore.password=u2tb6alf
ssl.truststore.password=u2tb6alf
sasl.mechanism=PLAIN
sasl.jaas.config=org.apache.kafka.common.security.plain.PlainLoginModule required username="admin" password="dc95frub";
EOF

cat > /tmp/client.properties.broker <<EOF
security.protocol=SASL_SSL
ssl.keystore.type=JKS
ssl.truststore.type=JKS
ssl.key.password=u2tb6alf
ssl.keystore.location=/tmp/cert/keystore.jks
ssl.truststore.location=/tmp/cert/truststore.jks
ssl.keystore.password=u2tb6alf
ssl.truststore.password=u2tb6alf
sasl.mechanism=PLAIN
sasl.jaas.config=org.apache.kafka.common.security.plain.PlainLoginModule required username="inter_broker_client" password="0vvgjdo0";
EOF

cat > /tmp/client.properties.controller <<EOF
security.protocol=SASL_SSL
ssl.keystore.type=JKS
ssl.truststore.type=JKS
ssl.key.password=u2tb6alf
ssl.keystore.location=/tmp/cert/keystore.jks
ssl.truststore.location=/tmp/cert/truststore.jks
ssl.keystore.password=u2tb6alf
ssl.truststore.password=u2tb6alf
sasl.mechanism=PLAIN
sasl.jaas.config=org.apache.kafka.common.security.plain.PlainLoginModule required username="controller_broker_client" password="hnit96wp";
EOF

cat > /tmp/client.properties.admin <<EOF
security.protocol=SASL_SSL
ssl.keystore.type=JKS
ssl.truststore.type=JKS
ssl.key.password=u2tb6alf
ssl.keystore.location=/tmp/cert/keystore.jks
ssl.truststore.location=/tmp/cert/truststore.jks
ssl.keystore.password=u2tb6alf
ssl.truststore.password=u2tb6alf
sasl.mechanism=PLAIN
sasl.jaas.config=org.apache.kafka.common.security.plain.PlainLoginModule required username="admin" password="dc95frub";
EOF

cat > /tmp/client.properties.telebot <<EOF
security.protocol=SASL_SSL
ssl.keystore.type=JKS
ssl.truststore.type=JKS
ssl.key.password=u2tb6alf
ssl.keystore.location=/tmp/cert/keystore.jks
ssl.truststore.location=/tmp/cert/truststore.jks
ssl.keystore.password=u2tb6alf
ssl.truststore.password=u2tb6alf
sasl.mechanism=PLAIN
sasl.jaas.config=org.apache.kafka.common.security.plain.PlainLoginModule required username="telebot-gpt" password="zyd8csub";
EOF




zyd8csub

/opt/bitnami/kafka/bin/kafka-broker-api-versions.sh --bootstrap-server "localhost:9092" --command-config /tmp/client.properties
/opt/bitnami/kafka/bin/kafka-broker-api-versions.sh --bootstrap-server "kafka:9092" --command-config /tmp/client.properties
/opt/bitnami/kafka/bin/kafka-broker-api-versions.sh --bootstrap-server "kafka.storage.svc:9092" --command-config /shared/client.properties1
/opt/bitnami/kafka/bin/kafka-broker-api-versions.sh --bootstrap-server "kafka.storage.svc.cluster.local:9092" --command-config /shared/client.properties1
/opt/bitnami/kafka/bin/kafka-broker-api-versions.sh --bootstrap-server "kafka.storage.svc.fzen.pro:9092" --command-config /shared/client.properties1
/opt/bitnami/kafka/bin/kafka-broker-api-versions.sh --bootstrap-server "kafka-controller-headless.storage.svc:9092" --command-config /shared/client.properties1
/opt/bitnami/kafka/bin/kafka-broker-api-versions.sh --bootstrap-server "kafka-controller-headless.storage.svc.cluster.local:9092" --command-config /shared/client.properties1
/opt/bitnami/kafka/bin/kafka-broker-api-versions.sh --bootstrap-server "kafka-controller-headless.storage.svc.fzen.pro:9092" --command-config /shared/client.properties1
/opt/bitnami/kafka/bin/kafka-broker-api-versions.sh --bootstrap-server "kafka-controller-0.kafka-controller-headless.storage.svc.fzen.pro:9092" --command-config /shared/client.properties1

openssl s_client -connect kafka:9092


/opt/bitnami/kafka/bin/kafka-broker-api-versions.sh --bootstrap-server "kafka:9092" --command-config /tmp/client.properties
/opt/bitnami/kafka/bin/kafka-broker-api-versions.sh --bootstrap-server "kafka:9092" --command-config /tmp/client.properties
/opt/bitnami/kafka/bin/kafka-broker-api-versions.sh --bootstrap-server "kafka:9092" --command-config /tmp/client.properties
/opt/bitnami/kafka/bin/kafka-broker-api-versions.sh --bootstrap-server "kafka:9092" --command-config /tmp/client.properties
/opt/bitnami/kafka/bin/kafka-broker-api-versions.sh --bootstrap-server "kafka:9092" --command-config /tmp/client.properties
/opt/bitnami/kafka/bin/kafka-broker-api-versions.sh --bootstrap-server "kafka:9092" --command-config /tmp/client.properties
/opt/bitnami/kafka/bin/kafka-broker-api-versions.sh --bootstrap-server "kafka:9092" --command-config /tmp/client.properties
/opt/bitnami/kafka/bin/kafka-broker-api-versions.sh --bootstrap-server "kafka:9092" --command-config /tmp/client.properties
/opt/bitnami/kafka/bin/kafka-broker-api-versions.sh --bootstrap-server "kafka:9092" --command-config /tmp/client.properties
/opt/bitnami/kafka/bin/kafka-broker-api-versions.sh --bootstrap-server "kafka:9092" --command-config /tmp/client.properties
/opt/bitnami/kafka/bin/kafka-broker-api-versions.sh --bootstrap-server "kafka:9092" --command-config /tmp/client.properties
/opt/bitnami/kafka/bin/kafka-broker-api-versions.sh --bootstrap-server "kafka:9092" --command-config /tmp/client.properties
/opt/bitnami/kafka/bin/kafka-broker-api-versions.sh --bootstrap-server "kafka:9092" --command-config /tmp/client.properties
/opt/bitnami/kafka/bin/kafka-broker-api-versions.sh --bootstrap-server "kafka:9092" --command-config /tmp/client.properties
/opt/bitnami/kafka/bin/kafka-broker-api-versions.sh --bootstrap-server "kafka:9092" --command-config /tmp/client.properties
/opt/bitnami/kafka/bin/kafka-broker-api-versions.sh --bootstrap-server "kafka:9092" --command-config /tmp/client.properties

kafka-topics.sh --list --bootstrap-server kafka:9092 --command-config /tmp/client.properties
kafka-topics.sh --create --topic test-topic --bootstrap-server kafka:9092 --command-config /tmp/client.properties
kafka-topics.sh --list --bootstrap-server kafka:9092 --command-config /tmp/client.properties


/opt/bitnami/kafka/bin/kafka-acls.sh --bootstrap-server $KAFKA_SERVICE --list --command-config /shared/client.properties


/opt/bitnami/kafka/bin/kafka-acls.sh --bootstrap-server $KAFKA_SERVICE --add --allow-principal User:telebot-gpt --operation Write --topic '*' --command-config /shared/client.properties

/opt/bitnami/kafka/bin/kafka-acls.sh --bootstrap-server $KAFKA_SERVICE --add --allow-principal User:telebot-gpt --operation Read --topic '*' --command-config /shared/client.properties

/opt/bitnami/kafka/bin/kafka-acls.sh --bootstrap-server $KAFKA_SERVICE --add --allow-principal User:telebot-gpt --operation Read --group '*' --command-config /shared/client.properties

/opt/bitnami/kafka/bin/kafka-acls.sh --bootstrap-server $KAFKA_SERVICE --list --command-config /shared/client.properties

/opt/bitnami/kafka/bin/kafka-acls.sh --bootstrap-server $KAFKA_SERVICE --add --allow-principal User:admin --operation All --cluster --command-config /shared/client.properties