# Возможные проблемы с сетью и методы диагностики

| **Проблема**                          | **Возможные причины**                                      | **Методы диагностики**                                           |
|---------------------------------------|------------------------------------------------------------|------------------------------------------------------------------|
| **Высокая задержка (ping высокий)**   | Перегруженный канал, проблема с маршрутизацией, DDoS       | `ping -c 4 example.com`, `mtr example.com`                       |
| **Потеря пакетов**                    | Проблемы с сетью, перегрузка, неисправное оборудование     | `ping -c 100 example.com`, `traceroute example.com`              |
| **Нет доступа к серверу (ICMP, TCP)** | Брандмауэр блокирует, проблемы с маршрутизацией, DDoS      | `ping`, `telnet example.com 80`, `iptables -L -n -v`             |
| **Много открытых соединений**         | DDoS, утечки соединений, неправильно настроенный NAT       | `ss -s`, `netstat -an \| wc -l`, `conntrack -L \| wc -l`         |
| **Низкая скорость сети**              | Перегрузка сети, дуплексные конфликты, потери пакетов      | `iperf3 -c example.com`, `ethtool eth0`                          |
| **Ошибки на сетевом интерфейсе**      | Проблема с кабелем, драйвером, перегрузка                  | `ip -s link show eth0`, `dmesg \| grep eth`                      |
| **Проблемы с DNS**                    | Неверный DNS-сервер, кеширование, блокировки               | `dig example.com`, `nslookup example.com`                        |
| **Перегрузка CPU (ksoftirqd высок)**  | Сетевая обработка перегружает CPU                          | `top -H -p $(pgrep -d',' -x ksoftirqd)`, `/proc/softirqs`        |
| **Слишком много соединений в NAT**    | Переполнение conntrack, большое число исходящих соединений | `conntrack -L \| wc -l`, `sysctl net.netfilter.nf_conntrack_max` |
| **Некорректная маршрутизация**        | Ошибочные таблицы маршрутов, проблемы с шлюзом             | `ip route show`, `traceroute example.com`                        |
| **Заблокирован трафик iptables**      | Неправильные правила в `iptables`, `firewalld`             | `sudo iptables -L -n -v`, `sudo nft list ruleset`                |

# Пошаговая диагностика сетевых проблем

Этот список поможет вам последовательно проверить возможные проблемы с сетью и найти их причину.

## 1️⃣ Проверка физического соединения
| **Что проверить?**           | **Как проверить?**     | **Что делать, если проблема?**                                                  |
|------------------------------|------------------------|---------------------------------------------------------------------------------|
| Кабель и сетевой интерфейс   | `ip link show eth0`    | Если `NO-CARRIER` — проверить кабель, порт коммутатора.                         |
| Ошибки на интерфейсе         | `ip -s link show eth0` | Если много `RX errors` или `TX errors` — заменить кабель или проверить драйвер. |

---

## 2️⃣ Проверка связи с сервером
| **Что проверить?**       | **Как проверить?**       | **Что делать, если проблема?**              |
|--------------------------|--------------------------|---------------------------------------------|
| Доступен ли сервер?      | `ping -c 4 example.com`  | Если нет ответа — перейти к `traceroute`.   |
| Маршрутизация до сервера | `traceroute example.com` | Если пакет застревает — проверить маршруты. |

---

## 3️⃣ Проверка локального соединения
| **Что проверить?**           | **Как проверить?**      | **Что делать, если проблема?**                         |
|------------------------------|-------------------------|--------------------------------------------------------|
| Сервер слушает нужный порт?  | `ss -tulnp \| grep :80` | Если нет — убедиться, что сервис запущен.              |
| Доступ с локальной машины    | `curl -I localhost:80`  | Если не отвечает — проверить `iptables` и `firewalld`. |

---

## 4️⃣ Проверка внешнего доступа
| **Что проверить?**           | **Как проверить?**         | **Что делать, если проблема?**                       |
|------------------------------|----------------------------|------------------------------------------------------|
| Открыт ли порт на сервере?   | `sudo iptables -L -n -v`   | Если порт заблокирован, разрешить его в `iptables`.  |
| Доступ извне                 | `nc -zv example.com 80`    | Если нет соединения — проверить NAT и маршрутизацию. |

---

## 5️⃣ Проверка NAT и брандмауэра
| **Что проверить?**        | **Как проверить?**      | **Что делать, если проблема?**                                       |
|---------------------------|-------------------------|----------------------------------------------------------------------|
| NAT-таблица перегружена?  | `conntrack -L \| wc -l` | Если число соединений близко к `nf_conntrack_max` — увеличить лимит. |
| Блокирует ли firewall?    | `sudo nft list ruleset` | Если блокирует — скорректировать правила.                            |

---

## 6️⃣ Проверка производительности сети
| **Что проверить?**     | **Как проверить?**                      | **Что делать, если проблема?**                   |
|------------------------|-----------------------------------------|--------------------------------------------------|
| Скорость соединения    | `iperf3 -c example.com`                 | Если скорость низкая — проверить дуплекс и MTU.  |
| Перегрузка CPU от сети | `top -H -p $(pgrep -d',' -x ksoftirqd)` | Если `ksoftirqd` грузит CPU — настроить RPS/RFS. |

---

## 7️⃣ Проверка на DDoS и аномальную активность
| **Что проверить?**               | **Как проверить?**                                                                         | **Что делать, если проблема?**                                        |
|----------------------------------|--------------------------------------------------------------------------------------------|-----------------------------------------------------------------------|
| Количество активных соединений   | `ss -s`                                                                                    | Если слишком много — проверить IP-адреса атакующих.                   |
| Чрезмерная нагрузка от IP        | `netstat -ntu \| awk '{print $5}' \| cut -d: -f1 \| sort \| uniq -c \| sort -nr \| head`   | Если один IP делает тысячи запросов — заблокировать через `iptables`. |

---